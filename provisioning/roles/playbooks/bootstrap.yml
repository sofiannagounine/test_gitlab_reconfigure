---
####################################
# Setup ssh deploy user from scratch
####################################
- hosts: newservers

  vars_prompt:
    # You may need to install passlib for this to work (pip install passlib)
    - name: 'root_hashed_password'
      prompt: "Enter the root hashed user password (python -c \"from passlib.hash import sha512_crypt; import getpass; print sha512_crypt.encrypt(getpass.getpass())\""
      private: yes

    # You may need to install passlib for this to work (pip install passlib)
    - name: 'deploy_hashed_password'
      prompt: "Enter the deploy hashed user password (python -c \"from passlib.hash import sha512_crypt; import getpass; print sha512_crypt.encrypt(getpass.getpass())\""
      private: yes

  tasks:

  - name: install sudo command
    apt:
      pkg: "{{ item }}"
      state: present
    with_items:
      - "sudo"

  - name: Add deployment user
    user: 
      name: deploy 
      password: '{{ deploy_hashed_password }}'

  - name: Add authorized deploy key
    authorized_key: 
      user: deploy
      state: present
      key: "{{ lookup('file', '{{ playbook_dir }}/../keys/id_rsa_mbp_p.pub') }}"

  - name: Remove sudo group rights
    lineinfile: 
      dest: /etc/sudoers 
      regexp: "^%sudo" 
      state: absent

  - name: Add deploy user to sudoers
    lineinfile:
      dest: /etc/sudoers 
      regexp: "deploy ALL" 
      line: "deploy ALL=(ALL) ALL" 
      state: present
      create: yes

  - name: Disallow root SSH access
    lineinfile: 
      dest: /etc/ssh/sshd_config 
      regexp: "^PermitRootLogin" 
      line: "PermitRootLogin no" 
      state: present
    notify: Restart sshd

  - name: Disallow password authentication
    lineinfile: 
      dest: /etc/ssh/sshd_config 
      regexp: "^PasswordAuthentication" 
      line: "PasswordAuthentication no"
      state: present
    notify: Restart sshd

  - name: Change root password
    user:
      name: root
      password: '{{ root_hashed_password }}'

  handlers:
    - name: Restart sshd
      action: service name=sshd state=restarted
